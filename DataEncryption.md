# 7.1 MysQL서버의 데이터 암호화
>- MySQL 서버의 암호화 기능은 데이터베이스 서버와 디스크 사이의 데이터를 읽고 쓰는 지점에서 암호하 또는 복호화를 수행한다.
- MySQL서버에서 사용자의 쿼리를 처리하는 과정에서 테이브르이 데이터가 암호화되어 있는지 여부를 식별할 필요가 없으며 암호화 여부에 상관없이 모든 테이블이 동일한 처리과정을 거친다.
- 데이터 암호화 기능이 활성화되어 있더라도 MySQL 내부와 사용자 입장에서는 아무 차이가 없는데 이를 TDE 또는 Data at Rest Encryption 이라고 한다.

## 7.1.1 2단계 키 관리
>- MySQL 서버의 TDE 에서 암호하 키는 키링 플러그인에 의해 관리된다.
>>- keyring_file
>>- keyring_encrypted_file
>>- keyring_okv
>>- keyring_aws
- 위의 플러그인들은 마스터 키를 관리하는 방법만 다를뿐 서버 내부적으로 동작하는 방식은 모두 동일하다.
![](https://velog.velcdn.com/images/cmong0516/post/5554ee4f-9ddc-473f-975b-5589f46f59a9/image.png)
- MySQL 서버의 데이터 암호화는 마스터 키와 테이블스페이스 키 라는 두가지 종류의 키를 가지고 있는데 테이블스페이스 키는 프라이빗 키 라고도 한다.
MySQL 서버는 외부 키 관리 솔루션이나 디스크의 파일에서 마스터 키를 가져오고 암호화된 테이블이 생성될 때마다 해당 테이블을 위한 임의의 테이블스페이스 키를 발급한다.
MySQL 서버는 마스터 키를 이용해 테이블스페이스 키를 암호화 해서 각 테이블이 데이터 파일 헤더에 저장하고 이때 생성한 암호화된 테이블스페이스 키는 테이블이 삭제되지 않는한 변경되지 않는다.
- 테이블스페이스 키는 외부로 노출되지 않기 때문에 변경하지 않아도 안전하지만 마스터 키는 외부의 파일을 이용하기 때문에 노출될수도 있으므로 주기적으로 변경해주어야 한다.
>>- alter instance rotate innodb master key;
- 마스터 키를 변경하면 MySQL 서버는 기존의 마스터 키를 이용해 각 테이브르이 테이블스페이스 키를 복호화 후 새로운 마스터 키로 다시 암호화 한다.
- 마스터 키가 변경되는 동안 MySQL 서버의 테이블스페이스 키와 데이터 파일의 데이터는변경되지 않는데 테이블스페이스 키가 변경된다면 MySQL 서버는 데이터 파일의 모든 데이터를 다시 복호화했다가 다시 암호화 해야하는 엄청난 작업을 해야하고 이는 사용자 쿼리를 처리하는데도 영향을 미친다.
- MySQL TDE 에서 지원하는 암호화 알고리즘은 AES 256 이며 이외의 알고리즘은 지원되지 않는다.

## 7.1.2 암호화의 성능
>- MySQL 서버의 암호화는 TDE 방식으로 디스크에서 한번 읽은 데이터 페이지는 복호화 되어 InnoDB의 버퍼 풀에 적재되어 암호화 되지 않은 테이블과 동일한 성능을 보인다,
- 하지만 쿼리가 InnoDB 버퍼 풀에 존재하지 않는 데이터 페이지를 읽어야 하는 경우 복호화 과정을 거치기 때문에 쿼리 처리가 복호화 시간만큼 지연될것이고 암호화된 테이블이 변경되면 다시 디스크로 동기화될때 암호화 해야 하기 때문에 이 역시 지연되지만 데이터 페이지 저장은 사용자의 쿼리를 처리하는 스레드가 아닌 서버의 백그라운드 스레드가 수행하기 때문에 실제 사용자의 쿼리가 지연되는것은 아니다.
- AES 암호화 알고리즘은 평문의 길이가 짧은 경우 암호화 키의 크기에 따라 암호화된 결과의 용량이 더 커질수도 있지만 데이터 페이지는 암호화 키보다 훨씬 크기 때문에 암호화 결과가 평문의 결과와 동일한 크기의 암호문을 반환한다.
암호화 한다고 해서 InnoDB 버퍼 풀의 효율성이 달라지거나 메모리 사용 효율이 떨어지지는 않는다.

## 7.1.3 암호화의 복제
>- MySQL 서버의 복제에서 레플리카 서버는 소스 서버의 모든 사용자 데이터를 동기화하기 때문에 실제 데이터 파일도 동일할 것이라고 생각할수도 있지만 TDE 를 이용한 암호화 사용시 마스터 키와 테이블스페이스 키는 그렇지 않다.
- MySQL 서버에서 기본적으로 모든 노드는 각자의 마스터 키를 할당해야 하는데 데이터베이스 서버의 로컬 디렉터리에 마스터 키를 관리하는 경우 소스서버와 레플리카 서버가 다른 키를 가질수밖에 없겠지만 원격으로 키 관리 솔루션을 사용하는 경우에도 서버 소스와 레플리카 서버는 서로 다른 마스터 키를 갖도록 설정해야 한다.
- 마스터 키 자체가 레플리카로 복제되지 않기 때문에 테이블스페이스 키또한 레플리카로 복제되지 않는다.
- 소스 서버와 레플리카 서버는 서로 각자의 마스터 키와 테이블스페이스 키를 관리하기 때문에 복제 멤버들의 데이터 파일은 암호화 되기 전의 값이 동일하더라도 실제 암호화된 데이터가 저장된 데이터 파일의 내용은 완전히 달라진다.
- 마스터 키 로테이션을 실행하면 소스 서버와 레플리카 서버가 각각 서로 다른 마스터 키를 새로 발급받는다.
- MySQL 서버의 백업에서 TDE의 키링 파일을 백업하지 않는 경우가 있는데 키링 파일을 찾지 못하면 데이터 복구를 할수 없기때문에 키링 파일을 데이터 백업과 별도로 백업한다면 마스터 키 로테이션 명령으로 TDE의 마스터 키가 언제 변경되었는지 기억하고 있어야 한다.
보안을 위해 키링 파일을 데이터 파일과 별도로 보관하는 것을 권장하지만 복구를 감안하고 백업 방식을 선택해야 한다.

# 7.2 keyring_file 플러그인 설치
>- MySQL 서버의 데이터 암호화 기능인 TDE 의 암호화 키 관리는 플러그인 방식으로 제공된다고 했는데 커뮤니티 에디션에서는 keyring_file 플러그인만 가능하다.
- keyling_file 은 테이블스페이스 키를 암호화하기 위한 마스터 키를 디스크의 파일로 관리하는데 이때 마스터 키는 평문으로 디스크에 저장되어 마스터 키가 저장된 파일이 외부에 노출된다면 데이터 암호화는 보안에 취약해진다.
- MySQL 서버의 다른 플러그인과 달리 TDE 플러그인의 경우 서버가 시작되는 단계에서 가장 빨리 초기화 되어야 하는데 MySQL 의 설정파일(my.cnf) 에서 early-plugin-load 시스템 변수에 keyring_file 플러그인을 위한 라이브러리 "keyring_file.so" 를 명시하고 keyring_file 플러그인이 마스터 키를 저장할 키링 파일의 경로를 keyring_file_data 설정에 명시하면 된다.

# 7.3 테이블 암호화
- 키링 플러그인은 마스터 키를 생성하고 관리하는 부분까지만 담당하기에 어떤 키링 플러그인을 사용하던 관계없이 암호화된 테이블을 생성하고 활용하는 방법은 모두 동일하다.

## 7.3.1 테이블 생성

![](https://velog.velcdn.com/images/cmong0516/post/0fdd1a5a-8019-4398-8040-e660141252cb/image.png)

- 일반적인 테이블 생성 구분과 동일하며 마지막에 "encryption='y'" 옵션을 추가하면 이 테이블의 데이터가 디스크에 기록될때 자동으로 암호화 되어 저장되고 다시 디스크에서 메모리로 읽어올때 복호화 된다.

## 7.3.2 응용 프로그램 암호화와의 비교
>- 응용 프로그램에서 직접 암호화해서 MySQL 서버에 저장하는 경우도 있는데 이때 저장되는 칼럼의 값이 암호화 된것인지 여부를 MySQL 서버는 알지 못한다.
- 따라서 우선은 MySQL 의 암호화를 사용하자.

## 7.3.3 테이블스페이스 이동
>- 테이블을 다른 서버로 복사해야 하는 경우 , 특정 테이블의 데이터 파일만 백업했다가 복구하는 경우 테이블스페이스 이동기능이 레코드를 덤프했다가 복구하는 방식보다 훨씬 효율적이며 빠르다.
그런데 TDE 가 적용되어 암호화된 테이블의 경우 원본 서버와 목적지 서버의 암호화 키가 다르기 때문에 flush tables source_table for export; 명령어로 테이블스페이스를 익스포트 할수 있다.
이 명령이 실행되면 서버는 source_table 의 저장되지 않은 변경사항을 모두 디스크로 기록하고 더이상 source_table 에 접근할수 없게 한다.
그와 동시에 source_table 의 구조를 source_table.cfg 파일로 기록해둔다.
source_table.ibd 파일과 source_table.cfg 파일을 목적지 서버로 복사하여 unlock tables 명령을 실행하면 source_table 을 사용할수 있다.
- TDE로 암호화된 테이블에 대해 flush tables source_table for export 명령을 실행하면 mysql 서버는 임시로 사용할 마스터 키를 발급해서 source_table.cfp라는 파일로 기록하고 암호화된 테이블의 테이블스페이스를 기존 마스터 키로 복호화 한후 임시로 발급한 마스터 키를 이용해 다시 암호화 하여 데이터 파일의 헤더 부분에 저장한다.
암호호된 테이블의 경우 테이블스페이스 이동 기능을 사용할 때 반드시 데이터 팡리과 임시 마스터 키가 저장된 source_table.cfp 파일을 함께 복사해야 한다.
